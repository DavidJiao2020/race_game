<html>

<head>
</head>

<body>
  <div id="msg_div_id">
  </div>
  <div id="login_page_div_id">
    <div>
      Player name:
    </div>
    <input id="player_name_input_id">
    </input>
    <button id="login_button_id">login</button>
    <br><br>

  </div>

  <div id="lobby_page_div_id" hidden>
    <div>
      Rooms:
    </div>
    <div id="rooms_div_id">

    </div>
    <button id="create_room_button_id">
      Create Room
    </button>


    <div id="name_div_id">
      Hello:
    </div>
    <br>
    <div>
      Online Players:
    </div>
    <div id="players_div_id">

    </div>

  </div>

  <div id="room_page_div_id" hidden>
    <div>
      Room #:
    </div>
    <div id="room_number_div_id">

    </div>
    <div>
      Room Capacity:
    </div>
    <div id="room_capacity_div_id">
      8
    </div>
    <div>
      # of Players:
    </div>
    <div id="room_player_count_div_id">
      0
    </div>
    <div>
      Player List:
    </div>
    <div id="room_player_list_div_id">

    </div>
    <div>
      Host:
    </div>
    <div id="room_host_div_id">

    </div>
    <button id="room_start_game">
      Start Game
    </button>
    <button id="leave_room_button_id">
      Leave Room
    </button>
  </div>

  <script>
    ///////////////////////  GLOBAL  /////////////////////

    var g_top = {
      'player_name': null,
      'update_rate': 3000,
      'player_location': 'login',
      'room_id': null,
    }
    var br = document.createElement('br')

    function g_show_message(msg) {
      document.getElementById('msg_div_id').innerHTML = msg
    }

    function g_hide_message() {
      document.getElementById('msg_div_id').innerHTML = ''
    }

    ///////////////////  API FUNCTION  ///////////////////
    function send_api_data(api_name, api_data, on_return) {
      console.log('api_name: ' + api_name)
      console.log('api_data: ' + JSON.stringify(api_data))
      let url = '/api'
      let sender = new XMLHttpRequest();
      sender.open("POST", url);
      // Set the request header i.e. which type of content you are sending
      sender.setRequestHeader("Content-Type", "application/json")
      // Create a state change callback
      sender.onreadystatechange = function () {
        if (sender.readyState === 4 && sender.status === 200) {
          // Print received data from server
          console.log(`RESPONSETEXT (client end): -->${this.responseText}<--`)
          let res = JSON.parse(this.responseText)
          on_return(res)
        }
      }
      // Converting JSON data to string
      let req_data = JSON.stringify({ 'api_name': api_name, 'api_data': api_data });
      // Sending data with the
      sender.send(req_data)
    }

    //////////////////////  ROOM  //////////////////////////

    function display_room_player_list(player_names, host_name) {
      document.getElementById('room_player_count_div_id').innerHTML = Object.keys(player_names).length
      document.getElementById('room_player_list_div_id').innerHTML = Object.keys(player_names)
      document.getElementById('room_host_div_id').innerHTML = host_name
    }

    function display_room() {
      g_hide_message()
      g_top['player_location'] = 'room'
      document.getElementById('login_page_div_id').style.display = "none"
      document.getElementById('lobby_page_div_id').style.display = "none"
      document.getElementById('room_page_div_id').style.display = "block"
    }

    function create_room(player_name) {
      
      let api_data = { 'player_name': player_name }
      send_api_data('create_room', api_data, function (res) {
        if (res['status'] === 'fail') {
          console.log('warning: create room failure')
          console.log('message: ' + JSON.stringify(res['data']))
          g_show_message(res['msg'])
          return
        }
        g_top['room_id'] = res['data']['room_id']
        document.getElementById('room_number_div_id').innerHTML = res['data']['room_id']
        display_room_player_list(res['data']['player_names'], res['data']['host_name'])
        display_room()
      })
    }

    function join_room(player_name, room_id) {
      
      let api_data = { 'room_id': room_id, 'player_name': player_name }
      send_api_data('join_room', api_data, function (res) {
        if (res['status'] === 'fail') {
          console.log('warning: join room failure')
          console.log('message: ' + JSON.stringify(res['data']))
          g_show_message(res['msg'])
          return
        }
        g_top['room_id'] = res['data']['room_id']
        document.getElementById('room_number_div_id').innerHTML = res['data']['room_id']
        display_room_player_list(res['data']['player_names'], res['data']['host_name'])
        display_room()
      })
    }

    function leave_room(player_name) {
      let api_data = { 'player_name': player_name }
      send_api_data('leave_room', api_data, function (res) {
        if (res['status'] === 'fail') {
          console.log('warning: leave room failure')
          console.log('message: ' + JSON.stringify(res['data']))
          g_show_message(res['msg'])
          return
        }
        g_top['room_id'] = null
        lobby()
      })
    }

    function update_room(player_name, room_id) {
      let api_data={'player_name':player_name, 'room_id':room_id}
      send_api_data('update_room_player_list', api_data, function(res){
        if (res['status']==='fail'){
          g_show_message(res['msg'])
          return
        }
        display_room_player_list(res['data']['player_names'], res['data']['host_name'])
      })
    }

    ///////////////////////  LOBBY  ///////////////////////

    function display_lobby_player_list(res) {
      let players_div = document.getElementById("players_div_id")
      let data = res['players']
      //initialize
      players_div.innerHTML = ''
      //update
      for (let player in data) {
        console.log(data[player]['room_id'])
        let player_location = null
        if (data[player]['room_id'] === null) {
          player_location = 'lobby'
        } else {
          player_location = `room ${data[player]['room_id']}`
        }

        players_div.innerHTML += `${player}: ${player_location}`;
        players_div.appendChild(br)
      }
    }

    function display_lobby_room_list(res) {
      let rooms_div = document.getElementById("rooms_div_id")
      let data = res['rooms']
      let player_name=g_top['player_name']
      //initialize
      rooms_div.innerHTML = ''
      //update
      for (let room_id in data) {
        if (data[room_id]['is_started'] === 'no') {
          rooms_div.innerHTML += `Room ${room_id}: `;
          const button = document.createElement('button')
          button.id = 'room_' + room_id + '_button_id'
          button.textContent = 'Join Room'
          rooms_div.appendChild(button)
          rooms_div.appendChild(br)
        } else {
          rooms_div.innerHTML += `Room ${room_id}: Started`;
        }
      }
      for (let room_id in data) {
        if (data[room_id]['is_started'] === 'no') {
          const button = document.getElementById('room_' + room_id + '_button_id')
          button.onclick = function(){
            join_room(player_name, room_id)
          }
        }
      }
    }


    function update_lobby() {
      let api_data = { 'player_name': g_top['player_name'] }
      send_api_data('update_lobby', api_data, function (res) {
        console.log(res)
        let data = res['data']
        display_lobby_player_list(data)
        display_lobby_room_list(data)
      })
    }


    function lobby() {
      g_hide_message()
      document.getElementById('name_div_id').innerHTML = `Hello: ${g_top['player_name']}`
      update_lobby()

      g_top['player_location'] = 'lobby'
      document.getElementById('login_page_div_id').style.display = "none"
      document.getElementById('lobby_page_div_id').style.display = "block"
      document.getElementById('room_page_div_id').style.display = "none"
    }




    ///////////////////////  LOGIN  //////////////////////////


    function send_player_name(player_name) {
      let api_data = { 'player_name': player_name }
      send_api_data('login', api_data, function (res) {
        if (res['status'] === 'success') {
          g_top['player_name'] = player_name
          lobby()
        } else {
          document.getElementById('msg_div_id').innerHTML = res['msg']
        }
      })
    }

    function login(player_name) {
      send_player_name(player_name)
    }

    ///////////////  LIVE UPDATE  /////////////////


    function update() {
      console.log('update time: ' +Date.now())
      let player_name = g_top['player_name']
      let room_id = g_top['room_id']
      if (g_top['player_location'] === 'lobby') {
        update_lobby()
        console.log('lobby updated')
      }
      if (g_top['player_location'] === 'room') {
        update_room(player_name, room_id)
        console.log('room updated')
      }

    }


    ///////////////  MAIN  //////////////
    function main() {
      let login_button = document.getElementById('login_button_id');
      login_button.onclick = function () {
        let player_name = document.getElementById('player_name_input_id').value;
        login(player_name);
      }

      let create_room_button = document.getElementById('create_room_button_id');
      create_room_button.onclick = function () {
        create_room(g_top['player_name']);
      }

      let leave_room_button = document.getElementById('leave_room_button_id');
      leave_room_button.onclick = function () {
        leave_room(g_top['player_name']);
      }
      
      setInterval(update, g_top['update_rate']);
    }

    main();

  </script>

  <body>

</html>